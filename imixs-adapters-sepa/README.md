# Imixs SEPA Adapter

This adapter module provides services to export workflow invoice data into a sepa file.


## Model Based Configuration

The *imixs-sepa-adapter* can be combined with different kind of workflow models. The SEPA export is configured by the SEPA Model

<img src="sepa-export.png" />

This model must at least define an inital Task with the following Events:

 * SEPA Export Start = 100
 * SEPA Export Finished = 200
 * SEPA Export Failed = 300
 
Other tasks and events can be defined based on the required business logic. The module supports two kinds of models

### SEPA Linked Model

In the default setup the SEPA module links the invoices into the SEPA export workitem and updates the invoiced during the export process. For this purpose the init event defines the processing instruction for the linked invoice workitems:

	<sepa name="invoice_update">
		<modelversion>(^rechnungseingang)</modelversion>
		<task>5800</task>
		<event>300</event>
	</sepa> 


### SEPA Parallel Model

As an alternative to the linked model a parallel sepa model can be used to decouple the invoice process from the sepa process. In this case for each invoide a separate SEPA-Request item (type=sepa) will be created which is processed by the sepa export independent form the invoice workflow.

<img src="sepa-export-parallel.png" />

## The SepaScheduler

The SEPA export is managed by the SepaScheduler which is an implementation of the interface _org.imxis.workflow.scheduler.Scheduler_.
The scheduler configuration object must at least provide the following items:

 * \_model\_version = model version for the SEPA export
 * \_initial\_task = inital task ID
 * dbtr.IBAN = default debitor IBAN  
 * dbtr.BIC = default debitor BIC 
 * dbtr.NAME = default debitor NAME 
 
Aligned to the SEPA standard an invoice processed by the SepaScheduler should provide the following items. 

 * cdtr.IBAN = default debitor IBAN  
 * cdtr.BIC = default debitor BIC 
 * cdtr.NAME = default debitor NAME 
 * $workflowsummary = invoice/topic


**Note:** These are recommended default item names. The items can be change to the spec of an application and XSL template.   
 
### Data Source
 
The start event (100) must be linked to a report definition. The report describes the data source and the template to translate the 
data source into a SEPA file format. See the following example for a data source query defined by a report:

	(type:"workitem" AND $modelversion:"invoice-1.0.0")

This example configuration will select all invoices form the Model _invoice-1.0.0_. 


### Grouping the Data Source

The SeapScheduler automatically groups the data source by the attribute \_dbtr\_iban. This feature is optional and used to generate separate process instances for each debitor. 



## Updating Invoices / SEPA Request

In the sepa model the event *init* contains an "sepa invoice_update" definition to update the invoice :

	<sepa name="invoice_update">
		<modelversion>1.0.0</modelversion>
		<processid>5800</processid>
		<activityid>100</activityid>
	</sepa>

**Note:** In case of a sepa-parallel model the sepa request instance is updated.
 
The SepaScheduler automatically link the invoices with the sepa export Workitem.
This definition is equals to the SplitAndJoin "subprocess_update" except with the item tag which is not supported for SEPA. 	




## XSL Transformation

The sepa file is generated using the imixs-report functionality. The sepa report is assigned with a XSLT file to generate the output.
The sepa file format is standardized. See details [here](http://www.sepaforcorporates.com/sepa-implementation/sepa-xml-in-a-nutshell/).

### XML Data Source

The xml data source is generated by the set of selected invoices defined by report definition and the sepa-export workitem itself. So the numer of data entries is the count of invoices +1. 

To identify the type of document you can make use of the xsl select statement:


	....
	<xsl:template
		match="/data/document[normalize-space(item[@name = '$workflowgroup']/value) = 'SEPA-Export']">
		....
	</xsl:template>
	
	<xsl:template
		match="/data/document[normalize-space(item[@name = '$workflowgroup']/value) = 'Rechnungseingang']">
		....
	</xsl:template>
	.....


### XSD pain.001.003.03

To align the resulting sepa.xml file with the XSD pain.001.003.03, we do transform some of the origin data from the XML source.

__MsgId__: The tags 'MsgId' and 'PmtInfId' may not be longer as 35 characters. For that reason we remove the '-' from the $uniqueid to shorten the message ids. 

	...
	<MsgId>
		<xsl:value-of
			select="replace($exportWorkitem/item[@name='$uniqueid']/value, '-', '')" />
	</MsgId>
	...

__IBAN__: The tags 'iban' may not contain blanks which in genaral is valid to input iban. For that reason we remove the ' ' from the coresponding items.

	
	...
	<CdtrAcct>
		<Id>
			<IBAN>
				<xsl:value-of select="replace(item[@name='cdtr.iban']/value, ' ', '')" />
			</IBAN>
		</Id>
	</CdtrAcct>
	...

# Development

## Maven


The imxis-adapter-sepa module can be added into an applicaton module. The module provides CDI and EJB components. Optional the module contains also JSF pages to be used for frontends. 

Add the following maven dependency into a parent project:


	<!-- SEPA Adapter -->
	<dependency>
		<groupId>org.imixs.workflow</groupId>
		<artifactId>imixs-adapters-sepa</artifactId>
		<version>${org.imixs.adapters.version}</version>
		<scope>provided</scope>
	</dependency>
	